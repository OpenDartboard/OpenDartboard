name: Release

permissions:
  contents: write # grants GITHUB_TOKEN the ability to create GitHub Releases

on:
  push:
    tags:
      - "v*" # e.g. vX.X.X
  workflow_dispatch: # allows manual rebuilds

jobs:
  build-deb:
    runs-on: ubuntu-24.04-arm

    container:
      image: debian:12
      options: --platform linux/arm64

    defaults:
      run:
        working-directory: /github/workspace

    steps:
      # 1. Checkout repo (full history so changelogs work later)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Install build & runtime deps
      - name: Install apt packages
        run: |
          apt-get update -y
          xargs apt-get install -y < apt-packages.txt

      # 3. Derive version from tag (refs/tags/v0.0.1 -> 0.0.1)
      - id: vars
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      # 4. Build binary and .deb
      - name: Build + Package
        run: |
          make build
          make deb VERSION=${{ steps.vars.outputs.VERSION }}

      # 5. Change log
      - name: Generate CHANGELOG output
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            git log "$LAST_TAG..HEAD" --pretty=format:"- %s"
          else
            git log --pretty=format:"- %s"
          fi > changelog.txt
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # 5. Upload .deb to the release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb
          body: ${{ steps.changelog.outputs.changelog }}
          # GitHub autoâ€‘creates notes (disabled for manual releases)
          # generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
